name: Nightly Quality

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 03:00 UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unit-tests:
    name: Unit Tests (with coverage)
    runs-on: ubuntu-latest
    container:
      image: "ubuntu:26.04"
      options: --tmpfs /tmp:exec
    env:
      CC: gcc-16
      CXX: g++-16
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Install dependencies
        run: |
          apt-get --yes update
          apt-get --yes install eatmydata
          eatmydata apt-get --yes upgrade
          eatmydata apt-get --yes install \
            gcc-16 g++-16 gcovr \
            build-essential cmake git ninja-build gettext intltool perl xsltproc \
            libatk1.0-dev libavif-dev libcairo2-dev libcolord-dev libcolord-gtk-dev \
            libcups2-dev libcurl4-gnutls-dev libexiv2-dev libgdk-pixbuf-2.0-dev \
            libglib2.0-dev libgmic-dev libgphoto2-dev libgraphicsmagick1-dev \
            libgtk-3-dev libheif-dev libjpeg-dev libjson-glib-dev liblcms2-dev \
            liblensfun-dev liblua5.4-dev libopenexr-dev libopenjp2-7-dev \
            libosmgpsmap-1.0-dev libpango1.0-dev libpng-dev libportmidi-dev \
            libpotrace-dev libpugixml-dev libraw-dev librsvg2-dev libsaxon-java \
            libsdl2-dev libsecret-1-dev libsqlite3-dev libtiff5-dev libwebp-dev \
            libx11-dev libxml2-dev libxml2-utils po4a python3-jsonschema zlib1g-dev \
            libcmocka-dev

      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 1

      - name: Configure (Debug + Tests + Coverage)
        run: |
          mkdir build && cd build
          cmake -G Ninja \
            -DCMAKE_C_COMPILER=gcc-16 \
            -DCMAKE_CXX_COMPILER=g++-16 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_TESTING=ON \
            -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
            -DDONT_USE_INTERNAL_LIBRAW=OFF \
            ..

      - name: Build
        run: cmake --build build -- -j$(nproc)

      - name: Run Tests
        working-directory: build
        run: ctest --output-on-failure --timeout 120

      - name: Generate Coverage Report
        if: always()
        run: |
          cd build
          gcovr --root .. --exclude '.*external.*' --exclude '.*tests.*' \
            --html coverage.html --html-details \
            --print-summary
        continue-on-error: true

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: build/coverage*.html
          retention-days: 7

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    container:
      image: "ubuntu:26.04"
      options: --tmpfs /tmp:exec
    env:
      CC: gcc-16
      CXX: g++-16
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Install dependencies
        run: |
          apt-get --yes update
          apt-get --yes install eatmydata
          eatmydata apt-get --yes upgrade
          eatmydata apt-get --yes install \
            gcc-16 g++-16 \
            build-essential cmake git ninja-build gettext intltool perl xsltproc \
            libatk1.0-dev libavif-dev libcairo2-dev libcolord-dev libcolord-gtk-dev \
            libcups2-dev libcurl4-gnutls-dev libexiv2-dev libgdk-pixbuf-2.0-dev \
            libglib2.0-dev libgmic-dev libgphoto2-dev libgraphicsmagick1-dev \
            libgtk-3-dev libheif-dev libjpeg-dev libjson-glib-dev liblcms2-dev \
            liblensfun-dev liblua5.4-dev libopenexr-dev libopenjp2-7-dev \
            libosmgpsmap-1.0-dev libpango1.0-dev libpng-dev libportmidi-dev \
            libpotrace-dev libpugixml-dev libraw-dev librsvg2-dev libsaxon-java \
            libsdl2-dev libsecret-1-dev libsqlite3-dev libtiff5-dev libwebp-dev \
            libx11-dev libxml2-dev libxml2-utils po4a python3-jsonschema zlib1g-dev

      - uses: actions/checkout@v6
        with:
          submodules: false
          fetch-depth: 1

      - name: Get submodules
        run: |
          git submodule init
          git config submodule.src/tests/integration.update none
          git submodule update

      - name: Configure and Build (Release)
        run: |
          mkdir build && cd build
          cmake -G Ninja \
            -DCMAKE_C_COMPILER=gcc-16 \
            -DCMAKE_CXX_COMPILER=g++-16 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install \
            -DDONT_USE_INTERNAL_LIBRAW=ON \
            ..
          cmake --build . -- -j$(nproc)
          cmake --build . --target install

      - name: Run darktable-cli smoke benchmark
        run: |
          echo "=== Performance Smoke Test ==="
          echo "Processing test image with darktable-cli..."
          time ${{ github.workspace }}/install/bin/darktable-cli \
            --width 2000 --height 2000 \
            --hq true --apply-custom-presets false \
            data/pixmaps/256x256/darktable.png \
            /tmp/bench_output.png \
            --core --disable-opencl --conf host_memory_limit=8192 \
            --conf worker_threads=4 -t 4 \
            --conf plugins/lighttable/export/force_lcms2=FALSE \
            --conf plugins/lighttable/export/iccintent=0 \
            2>&1 | tee /tmp/benchmark_results.txt

          echo "=== Benchmark Complete ==="

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: /tmp/benchmark_results.txt
          retention-days: 30
