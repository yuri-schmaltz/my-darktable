name: "CodeQL"

on:
  push:
    branches: [ master ]
    paths-ignore:
      - "po/**"
      - "packaging/**"
      - "data/latex/**"
      - "data/lua/**"
      - "data/pixmaps/**"
      - "data/pswp/**"
      - "data/style/**"
      - "data/themes/**"
      - "data/watermarks/**"
      - "tools/*"
      - "**.md"
  pull_request:
    branches: [ master ]
    paths-ignore:
      - "po/**"
      - "packaging/**"
      - "data/latex/**"
      - "data/lua/**"
      - "data/pixmaps/**"
      - "data/pswp/**"
      - "data/style/**"
      - "data/themes/**"
      - "data/watermarks/**"
      - "tools/*"
      - "**.md"
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Mondays at 06:00 UTC

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  analyze:
    name: Analyze (C/C++)
    runs-on: ubuntu-latest
    container:
      image: "ubuntu:26.04"
      options: --tmpfs /tmp:exec

    env:
      DEBIAN_FRONTEND: noninteractive

    strategy:
      fail-fast: false
      matrix:
        language: [ 'c-cpp' ]

    steps:
      - name: Install system dependencies
        run: |
          apt-get --yes update
          apt-get --yes install \
            build-essential cmake git ninja-build gettext intltool perl xsltproc \
            gcc-16 g++-16 \
            libatk1.0-dev libavif-dev libcairo2-dev libcolord-dev libcolord-gtk-dev \
            libcups2-dev libcurl4-gnutls-dev libexiv2-dev libgdk-pixbuf-2.0-dev \
            libglib2.0-dev libgmic-dev libgphoto2-dev libgraphicsmagick1-dev \
            libgtk-3-dev libheif-dev libjpeg-dev libjson-glib-dev liblcms2-dev \
            liblensfun-dev liblua5.4-dev libopenexr-dev libopenjp2-7-dev \
            libosmgpsmap-1.0-dev libpango1.0-dev libpng-dev libportmidi-dev \
            libpotrace-dev libpugixml-dev libraw-dev librsvg2-dev libsaxon-java \
            libsdl2-dev libsecret-1-dev libsqlite3-dev libtiff5-dev libwebp-dev \
            libx11-dev libxml2-dev libxml2-utils zlib1g-dev

      - uses: actions/checkout@v6
        with:
          submodules: false
          fetch-depth: 1

      - name: Get submodules
        run: |
          git submodule init
          git config submodule.src/tests/integration.update none
          git submodule update

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Configure and Build
        env:
          CC: gcc-16
          CXX: g++-16
        run: |
          mkdir build && cd build
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DDONT_USE_INTERNAL_LIBRAW=ON \
            ..
          cmake --build . -- -j$(nproc)

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
